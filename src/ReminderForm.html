<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <style>
      body { font-family:"Segoe UI",Tahoma,sans-serif; padding:20px; background:#f5f5f5; }
      .container { background:#fff; border-radius:8px; padding:20px; box-shadow:0 2px 4px rgba(0,0,0,.1); }
      .form-group { margin-bottom:20px; }
      label { font-weight:600; display:block; margin-bottom:5px; }
      input[type="text"],input[type="datetime-local"],input[type="date"],select {
        width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:4px;
      }
      input[type="checkbox"] { transform:scale(1.2); margin-left:8px; }
      .button-group { display:flex; gap:10px; }
      button { flex:1; padding:12px; border:none; border-radius:4px; font-weight:600; cursor:pointer; }
      .btn-primary { background:#1976d2; color:#fff; }
      .btn-secondary { background:#757575; color:#fff; }
      .cell-info { background:#e3f2fd; padding:10px; border-left:4px solid #1976d2; border-radius:4px; margin-bottom:15px; }
      .help-text { font-size:12px; color:#666; }
    </style>
  </head>
  <body>
    <div class="container">
      <h3>Set Event</h3>
      <div class="form-group cell-info">
        <strong>Selected Cell:</strong> <span id="cellDisplay">Loading...</span>
        <input type="hidden" id="cellInfo" />
      </div>
      <form id="reminderForm">
        <div class="form-group">
          <label for="msg">Event Message *</label>
          <input type="text" id="msg" required />
        </div>

        <div class="form-group">
          <label>All Day Event <input type="checkbox" id="allDay" onchange="toggleDateTimeInput()" /></label>
          <div class="help-text">Check if this is an all-day event</div>
        </div>

        <div class="form-group">
          <label for="due">Due Date & Time *</label>
          <input type="datetime-local" id="due" required />
          <input type="date" id="dueDate" style="display:none;" />
        </div>

        <div class="form-group">
          <label for="repeat">Repeat</label>
          <select id="repeat">
            <option value="none">No Repeat</option>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
            <option value="yearly">Yearly</option>
          </select>
        </div>

        <div class="form-group">
          <label>Notification</label>
          <div style="display:flex; gap:5px;">
            <input type="number" id="notifValue" min="1" placeholder="10" style="flex:1;" />
            <select id="notifUnit" style="flex:1;">
              <option value="">None</option>
              <option value="minutes">Minutes</option>
              <option value="hours">Hours</option>
              <option value="days">Days</option>
              <option value="weeks">Weeks</option>
            </select>
          </div>
          <small>Set how long before the event you want a popup reminder.</small>
        </div>

        <div class="button-group">
          <button type="button" class="btn-secondary" onclick="cancelForm()">Cancel</button>
          <button type="submit" class="btn-primary">Add Event</button>
        </div>
      </form>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
        initializeForm();
        setInterval(refreshSelectedCell, 2000);
      });

      function initializeForm(){
        google.script.run.withSuccessHandler(handleCellResponse).getActiveCellA1();
        const now=new Date();
        const oneHourLater=new Date(now.getTime()+60*60*1000);
        document.getElementById("due").value=new Date(oneHourLater.getTime()-oneHourLater.getTimezoneOffset()*60000).toISOString().slice(0,16);
      }

      function handleCellResponse(cellInfo){
        if(cellInfo){ 
          document.getElementById("cellDisplay").textContent=cellInfo.sheetName+"!"+cellInfo.cellRef;
          document.getElementById("cellInfo").value=JSON.stringify(cellInfo);
          google.script.run.withSuccessHandler(val=>{
            const msg=document.getElementById("msg");
            if(!msg.value || msg.value===msg.getAttribute("data-lastCellValue")) {
              msg.value=val;
              msg.setAttribute("data-lastCellValue",val);
            }
          }).getCellValue(cellInfo.cellRef,cellInfo.sheetName,cellInfo.spreadsheetId);
        }
      }

      function refreshSelectedCell(){
        google.script.run.withSuccessHandler(handleCellResponse).getActiveCellA1();
      }

      function toggleDateTimeInput(){
        const allDay=document.getElementById("allDay").checked;
        document.getElementById("due").style.display=allDay?"none":"block";
        document.getElementById("dueDate").style.display=allDay?"block":"none";
      }

      document.getElementById("reminderForm").addEventListener("submit",function(e){
        e.preventDefault();
        const msg=document.getElementById("msg").value.trim();
        const allDay=document.getElementById("allDay").checked;
        const repeat=document.getElementById("repeat").value;
        const cellInfo=JSON.parse(document.getElementById("cellInfo").value);
        let due=allDay?document.getElementById("dueDate").value:document.getElementById("due").value;
        let notification=null;
        const notifValue=document.getElementById("notifValue").value;
        const notifUnit=document.getElementById("notifUnit").value;
        if(notifValue && notifUnit){ notification={ value:notifValue, unit:notifUnit }; }
        google.script.run.withSuccessHandler(()=>google.script.run.showReminderSidebar())
          .createReminder(cellInfo,due,msg,allDay,repeat,notification);
      });

      function cancelForm(){ google.script.host.close(); }
    </script>
  </body>
</html>
